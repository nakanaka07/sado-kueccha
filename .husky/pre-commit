#!/bin/sh

# Pre-commit hooks for sado-kueccha
# Ensures code quality before commits

echo "ğŸ” Running pre-commit checks..."

# Function to handle errors
handle_error() {
  echo "âŒ Pre-commit check failed: $1"
  exit 1
}

# 1. Type check first (fastest failure)
echo "ğŸ“‹ Type checking..."
pnpm type-check || handle_error "Type check failed"

# 2. Lint staged files
echo "ğŸ§¹ Linting staged files..."
pnpm lint-staged || handle_error "Linting failed"

# 3. Run tests if relevant files are staged
STAGED_FILES=$(git diff --cached --name-only)
if echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null || \
   echo "$STAGED_FILES" | grep -E '\.(test|spec)\.(ts|tsx|js|jsx)$' > /dev/null || \
   echo "$STAGED_FILES" | grep -E '(vitest|jest)\.config\.' > /dev/null || \
   echo "$STAGED_FILES" | grep -E 'package\.json$' > /dev/null; then
  echo "ğŸ§ª Running tests..."
  pnpm test:run || handle_error "Tests failed"
else
  echo "â­ï¸  Skipping tests (no relevant files changed)"
fi

echo "âœ… All pre-commit checks passed!"
