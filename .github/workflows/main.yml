name: 'ğŸš€ CI/CD Pipeline - Build & Deploy'

# å®Ÿè¡Œåã®å‹•çš„è¨­å®šï¼ˆ2025å¹´æ–°æ©Ÿèƒ½ï¼‰
run-name: 'Deploy to Pages by @${{ github.actor }} from ${{ github.ref_name }}'

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆæœ€æ–°åŒ–ãƒ»æœ€é©åŒ–ï¼‰
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'vite.config.ts'
      - 'tsconfig*.json'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  release:
    types: [published]
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾å¿œï¼‰
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒ'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: false
        type: boolean

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šæœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆOpenID Connectå¯¾å¿œï¼‰
permissions:
  contents: read
  pages: write
  id-token: write
  actions: read
  checks: read

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ï¼šãƒ–ãƒ©ãƒ³ãƒåˆ¥ç®¡ç†
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°ï¼ˆ2025å¹´æ¨å¥¨æ§‹æˆï¼‰
env:
  NODE_VERSION: '22.14.0' # æœ€æ–°LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
  PNPM_VERSION: '10.13.1' # æœ€æ–°å®‰å®šç‰ˆå›ºå®š
  CI: true
  NODE_ENV: production
  FORCE_COLOR: 3

jobs:
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ»ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨å®Ÿè¡Œæ™‚ï¼‰
  security-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit
          disable-sudo: true
          disable-file-monitoring: false

      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Verify lockfile
        run: |
          echo "ğŸ” Verifying pnpm-lock.yaml integrity..."
          pnpm install --frozen-lockfile --dry-run

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          pnpm audit --audit-level high || {
            echo "âš ï¸ Security vulnerabilities found. Review required."
            pnpm audit --audit-level high --json > audit-results.json || true
            echo "Audit results saved for review."
          }

      - name: Check for outdated dependencies
        run: |
          echo "ğŸ“¦ Checking for outdated dependencies..."
          pnpm outdated || echo "Some dependencies are outdated. Consider updating."

  # å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆPRç”¨ãƒ»å¼·åŒ–ç‰ˆï¼‰
  quality-checks:
    if: github.event_name == 'pull_request' || inputs.skip_tests == false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      checks: write
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        check-type: [typescript, linting, formatting, testing]

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit
          disable-sudo: true

      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript checking
        if: matrix.check-type == 'typescript'
        run: |
          echo "ğŸ”§ Running TypeScript type checking..."
          pnpm type-check

      - name: Run ESLint
        if: matrix.check-type == 'linting'
        run: |
          echo "ğŸ” Running ESLint..."
          pnpm lint --format=stylish

      - name: Run Prettier check
        if: matrix.check-type == 'formatting'
        run: |
          echo "ğŸ’… Checking code formatting..."
          pnpm format:check

      - name: Run tests with coverage
        if: matrix.check-type == 'testing'
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          pnpm test:coverage || {
            echo "âŒ Tests failed. Checking for test files..."
            find src -name "*.test.*" -o -name "*.spec.*" | head -5
            exit 1
          }

      - name: Upload coverage reports
        if: matrix.check-type == 'testing' && github.event_name == 'pull_request'
        uses: codecov/codecov-action@c16abc29c95fcf9174b58eb7e1abf4c866893bc8 # v4.1.1
        with:
          token: ${{ secrets.CODECOV_TOKEN || '' }}
          fail_ci_if_error: false
          verbose: true
  # ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ»æ‰‹å‹•å®Ÿè¡Œç”¨ãƒ»å¼·åŒ–ç‰ˆï¼‰
  build-and-deploy:
    needs: [security-audit]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'release' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    outputs:
      deployment-url: ${{ steps.deployment.outputs.page_url }}
      build-size: ${{ steps.build-stats.outputs.build-size }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit
          disable-sudo: true
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            nodejs.org:443
            registry.npmjs.org:443
            objects.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js with caching
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: Pre-build quality checks
        if: inputs.skip_tests != true
        run: |
          echo "ğŸ” Running pre-build quality checks..."
          echo "Running TypeScript check..."
          pnpm type-check
          echo "Running linter..."
          pnpm lint
          echo "Running tests..."
          pnpm test || {
            echo "âŒ Quality checks failed"
            exit 1
          }
          echo "âœ… All quality checks passed"

      - name: Verify environment configuration
        run: |
          echo "ğŸ”§ Verifying environment configuration..."
          echo "NODE_ENV: $NODE_ENV"
          echo "CI: $CI"
          echo "Repository: ${{ github.repository }}"
          echo "Base path will be: /${{ github.event.repository.name }}/"

          # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ï¼‰
          check_var() {
            if [ -n "${!1}" ]; then
              echo "âœ… $1 is configured"
            else
              echo "âŒ $1 is missing"
              return 1
            fi
          }

          check_var "VITE_GOOGLE_MAPS_API_KEY"
          check_var "VITE_GOOGLE_SPREADSHEET_ID"
          check_var "VITE_EMAILJS_SERVICE_ID"

          echo "âœ… Environment verification completed"
        env:
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}
          VITE_GOOGLE_SPREADSHEET_ID: ${{ secrets.VITE_GOOGLE_SPREADSHEET_ID }}
          VITE_EMAILJS_SERVICE_ID: ${{ secrets.VITE_EMAILJS_SERVICE_ID }}

      - name: Build application
        id: build
        run: |
          echo "ğŸ—ï¸ Starting optimized build process..."
          echo "Repository: ${{ github.repository }}"
          echo "Base path: /${{ github.event.repository.name }}/"
          echo "Build timestamp: $(date -Iseconds)"

          # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ–
          export NODE_OPTIONS="--max_old_space_size=4096"

          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          pnpm build

          echo "âœ… Build completed successfully"
        env:
          CI: true
          NODE_ENV: production
          VITE_BASE_PATH: /${{ github.event.repository.name }}/
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}
          VITE_GOOGLE_MAPS_MAP_ID: ${{ secrets.VITE_GOOGLE_MAPS_MAP_ID }}
          VITE_GOOGLE_SHEETS_API_KEY: ${{ secrets.VITE_GOOGLE_SHEETS_API_KEY }}
          VITE_GOOGLE_SPREADSHEET_ID: ${{ secrets.VITE_GOOGLE_SPREADSHEET_ID }}
          VITE_SHEET_RECOMMENDED: 'recommended:1043711248'
          VITE_SHEET_RYOTSU_AIKAWA: 'ryotsu_aikawa:95850266'
          VITE_SHEET_KANAI_SAWADA: 'kanai_sawada:431330115'
          VITE_SHEET_AKADOMARI_HAMOCHI: 'akadomari_hamochi:1375085632'
          VITE_SHEET_SNACK: 'snack:490189070'
          VITE_SHEET_TOILET: 'toilet:1271565248'
          VITE_SHEET_PARKING: 'parking:716861286'
          VITE_EMAILJS_SERVICE_ID: ${{ secrets.VITE_EMAILJS_SERVICE_ID }}
          VITE_EMAILJS_TEMPLATE_ID: ${{ secrets.VITE_EMAILJS_TEMPLATE_ID }}
          VITE_EMAILJS_PUBLIC_KEY: ${{ secrets.VITE_EMAILJS_PUBLIC_KEY }}

      - name: Analyze build output
        id: build-stats
        run: |
          echo "ğŸ“Š Analyzing build output..."

          if [ ! -d "./dist" ]; then
            echo "âŒ Build output directory not found"
            echo "Available directories:"
            ls -la
            exit 1
          fi

          if [ ! -f "./dist/index.html" ]; then
            echo "âŒ index.html not found in dist"
            echo "Contents of dist directory:"
            ls -la ./dist
            exit 1
          fi

          # ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºè¨ˆç®—
          BUILD_SIZE=$(du -sh ./dist | cut -f1)
          FILE_COUNT=$(find ./dist -type f | wc -l)

          echo "âœ… Build analysis completed"
          echo "ğŸ“¦ Build size: $BUILD_SIZE"
          echo "ğŸ“„ File count: $FILE_COUNT"
          echo "ğŸ•’ Analysis timestamp: $(date -Iseconds)"

          # GitHub Actions outputs
          echo "build-size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©æ¤œæŸ»
          echo "ğŸ”’ Running security scan on build output..."
          if grep -r "API_KEY\|SECRET\|PASSWORD\|TOKEN" ./dist/ --exclude-dir=node_modules || true; then
            echo "âš ï¸ Potential sensitive data found in build output. Review required."
          else
            echo "âœ… No sensitive data detected in build output"
          fi

      - name: Generate build report
        run: |
          echo "ğŸ“‹ Generating build report..."
          cat > build-report.md << EOF
          # Build Report ğŸ“Š

          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Build Size:** ${{ steps.build-stats.outputs.build-size }}
          **File Count:** ${{ steps.build-stats.outputs.file-count }}
          **Build Time:** $(date -Iseconds)

          ## Build Environment
          - Node.js: ${{ env.NODE_VERSION }}
          - pnpm: ${{ env.PNPM_VERSION }}
          - OS: ubuntu-latest

          ## Build Status
          âœ… Build completed successfully
          EOF

          echo "Build report generated"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      - name: Post-deployment verification
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployment time: $(date -Iseconds)"
          echo "ğŸ“¦ Build size: ${{ steps.build-stats.outputs.build-size }}"
          echo "ğŸ“„ File count: ${{ steps.build-stats.outputs.file-count }}"

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸã‚’Slackã‚„ãã®ä»–ã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã«é€ä¿¡ã™ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ 
          # echo "Sending deployment notification..."

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Performing cleanup..."
          # æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          rm -f .env.local .env.*.local 2>/dev/null || true
          echo "âœ… Cleanup completed"

  # é€šçŸ¥ãƒ»ãƒ¬ãƒãƒ¼ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify-success:
    needs: [build-and-deploy]
    if: success() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Deployment success notification
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š Deployment Summary:"
          echo "â”œâ”€â”€ URL: ${{ needs.build-and-deploy.outputs.deployment-url }}"
          echo "â”œâ”€â”€ Build Size: ${{ needs.build-and-deploy.outputs.build-size }}"
          echo "â”œâ”€â”€ Repository: ${{ github.repository }}"
          echo "â”œâ”€â”€ Branch: ${{ github.ref_name }}"
          echo "â”œâ”€â”€ Commit: ${{ github.sha }}"
          echo "â””â”€â”€ Timestamp: $(date -Iseconds)"

          # å°†æ¥çš„ã«Slackã€Teamsã€Discordç­‰ã¸ã®é€šçŸ¥ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã“ã“ã«å®Ÿè£…
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"âœ… Deployment successful: ${{ needs.build-and-deploy.outputs.deployment-url }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # å¤±æ•—æ™‚ã®é€šçŸ¥ãƒ»ãƒ‡ãƒãƒƒã‚°æƒ…å ±åé›†
  notify-failure:
    needs: [security-audit, quality-checks, build-and-deploy]
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read

    steps:
      - name: Failure analysis and notification
        run: |
          echo "âŒ Workflow failed!"
          echo "ğŸ” Failure Analysis:"
          echo "â”œâ”€â”€ Repository: ${{ github.repository }}"
          echo "â”œâ”€â”€ Branch: ${{ github.ref_name }}"
          echo "â”œâ”€â”€ Commit: ${{ github.sha }}"
          echo "â”œâ”€â”€ Actor: ${{ github.actor }}"
          echo "â”œâ”€â”€ Event: ${{ github.event_name }}"
          echo "â””â”€â”€ Timestamp: $(date -Iseconds)"
          echo ""
          echo "ğŸ“‹ Job Status:"
          echo "â”œâ”€â”€ Security Audit: ${{ needs.security-audit.result }}"
          echo "â”œâ”€â”€ Quality Checks: ${{ needs.quality-checks.result }}"
          echo "â””â”€â”€ Build & Deploy: ${{ needs.build-and-deploy.result }}"
          echo ""
          echo "ğŸ’¡ Troubleshooting Tips:"
          echo "1. Check the failed job logs above"
          echo "2. Verify all required secrets are configured"
          echo "3. Ensure code quality standards are met"
          echo "4. Check for dependency vulnerabilities"
          echo "5. Review recent commits for breaking changes"
